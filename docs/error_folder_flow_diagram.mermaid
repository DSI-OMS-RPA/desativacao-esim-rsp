graph TD
    Start([Iniciar Processo]) --> Lock["üîí Adquirir Lock"]
    Lock --> Discover["üìÇ Descobrir ficheiros XML no FTP"]
    Discover --> HasFiles{Ficheiros encontrados?}
    
    HasFiles -->|N√£o| NoFiles["‚ö†Ô∏è Alerta: Sem ficheiros"]
    NoFiles --> End1([Fim])
    
    HasFiles -->|Sim| Loop["üîÑ Para cada ficheiro..."]
    Loop --> GetFile["üì• Download do FTP para staging/"]
    
    GetFile --> DownloadOK{Download bem-sucedido?}
    
    DownloadOK -->|N√£o| DownloadErr["‚ùå Erro: Download failed"]
    DownloadErr --> MoveError1["‚û°Ô∏è mover para /error"]
    MoveError1 --> AddFailed1["üìä Adicionar a files_failed"]
    AddFailed1 --> LogError1["üìù Log: Download failed"]
    
    DownloadOK -->|Sim| ParseXML["üîç Parse XML"]
    ParseXML --> ParseOK{XML v√°lido?}
    
    ParseOK -->|N√£o| ParseErr["‚ùå Erro: XML parsing failed"]
    ParseErr --> MoveError2["‚û°Ô∏è mover para /error"]
    MoveError2 --> AddFailed2["üìä Adicionar a files_failed"]
    AddFailed2 --> LogError2["üìù Log: Parsing error"]
    
    ParseOK -->|Sim| Filter["üéØ Filtrar eSIM + DEACTIVATE"]
    Filter --> Process["‚öôÔ∏è Processar API (batches)"]
    
    Process --> ProcessOK{Processamento OK?}
    
    ProcessOK -->|Erro cr√≠tico| CritErr["‚ùå Erro: API/Connection"]
    CritErr --> MoveError3["‚û°Ô∏è mover para /error"]
    MoveError3 --> AddFailed3["üìä Adicionar a files_failed"]
    AddFailed3 --> LogError3["üìù Log: API error"]
    
    ProcessOK -->|Sim| CalcRate["üìà Calcular taxa de sucesso"]
    CalcRate --> CheckRate{Taxa ‚â• 95%?}
    
    CheckRate -->|Sim| Success["‚úÖ SUCESSO"]
    Success --> MoveDone["‚û°Ô∏è mover para /done (FTP)"]
    MoveDone --> MoveLocal["‚û°Ô∏è mover para /processed (local)"]
    MoveLocal --> AddSuccess["üìä Adicionar a files_processed"]
    AddSuccess --> LogSuccess["üìù Log: File processed successfully"]
    
    CheckRate -->|N√£o| ThreshErr["‚ùå Erro: Taxa < 95%"]
    ThreshErr --> CalcRate2["üìä Calcular percentagem (ex: 80%)"]
    CalcRate2 --> MoveError4["‚û°Ô∏è mover para /error com '%'"]
    MoveError4 --> AddFailed4["üìä Adicionar a files_failed"]
    AddFailed4 --> LogError4["üìù Log: Threshold failed (80%)"]
    
    LogError1 --> NextFile{Mais ficheiros?}
    LogError2 --> NextFile
    LogError3 --> NextFile
    LogError4 --> NextFile
    LogSuccess --> NextFile
    
    NextFile -->|Sim| Loop
    NextFile -->|N√£o| Report["üìä Gerar relat√≥rios"]
    Report --> Email["üìß Enviar email"]
    Email --> Cleanup["üßπ Cleanup"]
    Cleanup --> EndOK["‚úì Fim (exit 0)"]
    Cleanup --> End2([Fim])
    
    style Success fill:#90EE90
    style DownloadErr fill:#FFB6C6
    style ParseErr fill:#FFB6C6
    style CritErr fill:#FFB6C6
    style ThreshErr fill:#FFB6C6
    style MoveError1 fill:#FFE4B5
    style MoveError2 fill:#FFE4B5
    style MoveError3 fill:#FFE4B5
    style MoveError4 fill:#FFE4B5
    style MoveDone fill:#ADD8E6
    style Loop fill:#E6E6FA